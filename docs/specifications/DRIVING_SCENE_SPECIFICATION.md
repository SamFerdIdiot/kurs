# DrivingScene - Полная спецификация
## Complete DrivingScene Specification

**Дата:** 2025-11-15  
**Статус:** Для утверждения  
**Автор:** GitHub Copilot на основе уточнений владельца

---

## 🎯 Обзор / Overview

DrivingScene — это **основной игровой цикл**, состоящий из **двух отдельных сцен**:

1. **LocationScene (Развязка)** - Подготовка к путешествию
2. **TravelCinemaScene (Дорожное кино)** - Само путешествие

Обе сцены должны казаться **связанными** через плавные переходы.

---

## 📍 Stage 1: LocationScene (Развязка)

### Назначение

Локация — это место для подготовки к путешествию. Игрок может:
- Набирать ресурсы (покупки)
- Восстанавливать энергию (сон)
- Сдавать и получать квесты
- Работать за деньги

### Ключевые особенности

- ⏸️ **Время останавливается** - нет таймера
- 💰 **Ресурсы НЕ расходуются** - топливо, энергия сохраняются
- 🏢 **Все структуры здесь** - магазины, мотели, работодатели

---

## 📋 Stage 1: Техническая спецификация

### Класс: LocationScene

```cpp
class LocationScene : public Scene {
public:
    LocationScene(const LocationData& location);
    
    // Scene interface
    void handleInput(const sf::Event& event) override;
    void update(float deltaTime) override;
    void render(sf::RenderWindow& window) override;
    SceneType getNextScene() const override;
    bool isFinished() const override;
    
private:
    // Данные локации
    LocationData m_locationData;
    std::vector<Structure*> m_structures;
    
    // Состояние сцены
    bool m_finished = false;
    SceneType m_nextScene = SceneType::TRAVEL_CINEMA;
    
    // UI элементы
    LocationUI m_ui;
    StructureSelector m_structureSelector;
    
    // Функции
    void openStructure(StructureType type);
    void showDepartureConfirmation();
    void transitionToTravel();
};
```

---

## 🎨 Stage 1: Wireframe UI

```
┌────────────────────────────────────────────────────────────────┐
│  ЛОКАЦИЯ: Придорожная развязка              [💰 $250] [⚡ 85%] │
├────────────────────────────────────────────────────────────────┤
│                                                                  │
│     🏪 МАГАЗИН                    🛠️ МАСТЕРСКАЯ                │
│     "Купить припасы"             "Ремонт и улучшения"          │
│     [E] Войти                    [E] Войти                     │
│                                                                  │
│                      🚗 ВАШ АВТОМОБИЛЬ                          │
│                   BMW E30 Coupe (Sport)                         │
│                   Топливо: █████████░ 90/200L                   │
│                                                                  │
│     🏨 МОТЕЛЬ                     💼 АГЕНТСТВО РАБОТЫ           │
│     "Отдых и сон"                "Подработка"                   │
│     [E] Войти                    [E] Войти                     │
│                                                                  │
│     📋 ДОСКА ОБЪЯВЛЕНИЙ                                         │
│     "Квесты и задания"                                          │
│     [E] Посмотреть                                              │
│                                                                  │
├────────────────────────────────────────────────────────────────┤
│  [I] Инвентарь  [M] Карта  [Space] ВЫЕХАТЬ →                  │
└────────────────────────────────────────────────────────────────┘
```

---

## 🏗️ Stage 1: Структуры в локации

### 1. 🏪 Магазин (Shop)

**Функционал:**
- Покупка еды (восстановление энергии)
- Покупка воды
- Покупка топлива (канистры)
- Покупка инструментов
- Продажа ненужных предметов

**UI:**
```
┌──────────────────────────────────────┐
│  🏪 МАГАЗИН                           │
├──────────────────────────────────────┤
│  🍔 Еда                      $15     │
│  💧 Вода                     $10     │
│  ⛽ Канистра топлива (10L)   $25     │
│  🔧 Инструменты              $50     │
│                                       │
│  Ваши деньги: $250                   │
│  [↑/↓] Выбор  [Enter] Купить        │
└──────────────────────────────────────┘
```

### 2. 🛠️ Мастерская (Workshop)

**Функционал:**
- Ремонт автомобиля
- Заправка топливного бака
- Улучшения (опционально)

**Цены:**
- Ремонт: $80 (со скидкой механика: $56-64)
- Заправка: $1.50 за литр
- Полная заправка автоматически

**UI:**
```
┌──────────────────────────────────────┐
│  🛠️ МАСТЕРСКАЯ                       │
├──────────────────────────────────────┤
│  Состояние: Хорошее (85%)            │
│                                       │
│  🔧 Ремонт              $80          │
│  ⛽ Заправка (полная)   $165         │
│     (110L × $1.50)                   │
│                                       │
│  [Механик в команде: -20% скидка]   │
│  Итого: $196                         │
│                                       │
│  [Enter] Подтвердить  [Esc] Выйти   │
└──────────────────────────────────────┘
```

### 3. 🏨 Мотель (Motel)

**Функционал:**
- Сон (восстановление энергии до 100%)
- Сохранение игры
- Доступ к инвентарю

**Цена:** $20 за ночь

**UI:**
```
┌──────────────────────────────────────┐
│  🏨 МОТЕЛЬ                            │
├──────────────────────────────────────┤
│  🛏️ Переночевать      $20           │
│     Энергия: 65% → 100%              │
│                                       │
│  💾 Сохранить игру                   │
│                                       │
│  🎒 Инвентарь                        │
│                                       │
│  [Enter] Выбрать  [Esc] Выйти       │
└──────────────────────────────────────┘
```

### 4. 💼 Агентство работы (Work Agency)

**Функционал:**
- Выбор работы
- Работа тратит энергию, даёт деньги
- Разные типы работ

**Варианты работ:**
- 🔨 Грузчик: -30% энергии, +$50, 30 минут
- 📦 Курьер: -20% энергии, +$35, 20 минут
- 🧹 Уборка: -15% энергии, +$25, 15 минут

**UI:**
```
┌──────────────────────────────────────┐
│  💼 АГЕНТСТВО РАБОТЫ                 │
├──────────────────────────────────────┤
│  🔨 Грузчик                          │
│     Энергия: -30%  Оплата: +$50     │
│     Время: 30 минут                  │
│                                       │
│  📦 Курьер                           │
│     Энергия: -20%  Оплата: +$35     │
│     Время: 20 минут                  │
│                                       │
│  🧹 Уборка                           │
│     Энергия: -15%  Оплата: +$25     │
│     Время: 15 минут                  │
│                                       │
│  [↑/↓] Выбор  [Enter] Взять работу  │
└──────────────────────────────────────┘
```

### 5. 📋 Доска объявлений (Quest Board)

**Функционал:**
- Просмотр доступных квестов
- Принятие квестов
- Сдача выполненных квестов

**UI:**
```
┌──────────────────────────────────────┐
│  📋 ДОСКА ОБЪЯВЛЕНИЙ                 │
├──────────────────────────────────────┤
│  🔍 Найти пропавшую посылку          │
│     Награда: $150                    │
│     [Принять]                        │
│                                       │
│  ✅ Доставить товары (ВЫПОЛНЕНО)    │
│     Награда: $100                    │
│     [Сдать квест]                    │
│                                       │
│  [↑/↓] Выбор  [Enter] Действие      │
└──────────────────────────────────────┘
```

---

## 🚗 Stage 1: Подтверждение выезда

Когда игрок нажимает **Space** (ВЫЕХАТЬ), показывается окно подтверждения:

```
┌────────────────────────────────────────────────────────────┐
│  🚗 ПОДТВЕРЖДЕНИЕ ВЫЕЗДА                                   │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  Маршрут: Придорожная развязка → Портовый город           │
│  Расстояние: 120 км                                         │
│  Время в пути: ~2 часа                                     │
│                                                              │
│  ⛽ Расход топлива: 60L                                    │
│  💰 Текущий запас: 90L  ✅ ДОСТАТОЧНО                      │
│                                                              │
│  ⚡ Ваша энергия: 85%  ✅ В НОРМЕ                          │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │ ⚠️ ВНИМАНИЕ                                        │   │
│  │ На дороге могут встретиться случайные события      │   │
│  │ Подготовьте припасы и активные предметы!          │   │
│  └────────────────────────────────────────────────────┘   │
│                                                              │
│  [Enter] ВЫЕХАТЬ          [Esc] ОТМЕНИТЬ                   │
└────────────────────────────────────────────────────────────┘
```

**Проверки перед выездом:**
1. ✅ Достаточно топлива для поездки
2. ⚠️ Предупреждение, если топлива впритык
3. ❌ Блокировка выезда, если топлива недостаточно

---

## 🎬 Stage 2: TravelCinemaScene (Дорожное кино)

### Назначение

Путешествие между локациями в формате "дорожного кино" — игрок не управляет машиной напрямую, но встречает события.

### Ключевые особенности

- ⏱️ **Время идёт** - автоматически
- 🎭 **Случайные события** - 3-4 на дорогу
- 💬 **Диалоги** - 2-3 на дорогу (короткие воспоминания)
- 👤 **Встреча NPC** - 1 раз на 3 дороги
- 🎨 **Parallax фон** - движущиеся слои

---

## 📋 Stage 2: Техническая спецификация

### Класс: TravelCinemaScene

```cpp
class TravelCinemaScene : public Scene {
public:
    TravelCinemaScene(const Route& route);
    
    // Scene interface
    void handleInput(const sf::Event& event) override;
    void update(float deltaTime) override;
    void render(sf::RenderWindow& window) override;
    SceneType getNextScene() const override;
    bool isFinished() const override;
    
private:
    // Данные маршрута
    Route m_route;
    float m_progress = 0.0f;        // 0.0 - 1.0
    float m_travelTime = 0.0f;       // Прошедшее время
    float m_totalTravelTime;         // Общее время поездки
    
    // Система событий
    EventScheduler m_eventScheduler;
    std::queue<GameEvent> m_pendingEvents;
    GameEvent* m_currentEvent = nullptr;
    
    // Параллакс
    ParallaxBackground m_parallax;
    
    // Состояние
    bool m_finished = false;
    SceneType m_nextScene = SceneType::LOCATION;
    
    // Функции
    void scheduleEvents();
    void triggerEvent();
    void handleEventChoice(int choiceIndex);
    void updateParallax(float deltaTime);
};
```

---

## 🎨 Stage 2: Wireframe UI

```
┌────────────────────────────────────────────────────────────────┐
│  🚗 В ПУТИ: Портовый город              [⛽ 30L] [⚡ 85%]      │
├────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ☁️   ☁️        ☁️              ☁️           ☁️                │ Слой 1 (облака)
│                                                                  │
│     🌲  🌲      🏠         🌲       🌲                          │ Слой 2 (деревья)
│                                                                  │
│  ═══════════════════════════════════════════════════════════   │ Дорога
│                                                                  │
│              🚗 →→→                                             │ Автомобиль
│                                                                  │
│  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │ Земля
│                                                                  │
│  Прогресс: ████████████░░░░░░░░ 60%                            │
│  Осталось: ~45 минут                                            │
│                                                                  │
└────────────────────────────────────────────────────────────────┘
```

---

## 🎭 Stage 2: События на дороге

### Типы событий

События появляются как **всплывающие окна** поверх дорожного фона.

#### 1. Выбор события (Event)

```
┌────────────────────────────────────────────────────────────┐
│  ⚠️ ДОРОЖНОЕ СОБЫТИЕ                                       │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  На дороге лежит упавшее дерево, блокирующее проезд!       │
│  Что делаете?                                               │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │ > 🔧 Убрать дерево инструментами                   │   │
│  │   [-20% энергии, -10 минут]                        │   │
│  │   [Требуется: Инструменты в инвентаре]            │   │
│  └────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │   🚗 Объехать через поле                           │   │
│  │   [-15L топлива, -5 минут]                         │   │
│  └────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │   ⏳ Дождаться помощи                              │   │
│  │   [-30 минут]                                      │   │
│  └────────────────────────────────────────────────────┘   │
│                                                              │
│  [↑/↓] Выбор  [Enter] Подтвердить                          │
└────────────────────────────────────────────────────────────┘
```

**Механика пропуска:**
- Если есть **активный предмет** (инструменты) → можно использовать
- Если есть **способность NPC** (механик) → бонус к эффективности
- Если есть **пассивная способность** → автоматический бонус

#### 2. Диалог (воспоминание)

```
┌────────────────────────────────────────────────────────────┐
│  💭 ВОСПОМИНАНИЕ                                            │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  Вы вспоминаете, как впервые сели за руль этой машины...   │
│                                                              │
│  "Отец сказал: 'Береги её. Она провезёт тебя через всё,    │
│   если ты будешь заботиться о ней.'"                       │
│                                                              │
│  Воспоминание согревает душу.                               │
│  [Мораль команды +5%]                                       │
│                                                              │
│  [Enter] Продолжить                                         │
└────────────────────────────────────────────────────────────┘
```

**Формат диалогов:**
- 1-6 фраз максимум
- Короткие, атмосферные
- Могут давать бонусы к морали
- Инициируются вместо событий с шансом

#### 3. Встреча NPC

```
┌────────────────────────────────────────────────────────────┐
│  👤 ПОПУТЧИК НА ДОРОГЕ                                      │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  На обочине стоит мужчина средних лет с рюкзаком.          │
│  Он голосует, пытаясь поймать попутку.                     │
│                                                              │
│  "Эй! Подвезёте до города? Я механик, могу помочь с       │
│   машиной в дороге!"                                        │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │ > 👍 Взять попутчика                               │   │
│  │   [+NPC "Майк - Механик"]                          │   │
│  │   [Свободных мест: 2/4]                           │   │
│  └────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │   👋 Отказать вежливо                              │   │
│  └────────────────────────────────────────────────────┘   │
│                                                              │
│  [↑/↓] Выбор  [Enter] Подтвердить                          │
└────────────────────────────────────────────────────────────┘
```

**Частота:** 1 раз на 3 дороги

---

## 🔄 Переход между стадиями

### LocationScene → TravelCinemaScene

**Триггер:** Игрок нажимает Space и подтверждает выезд

**Последовательность:**
1. LocationScene показывает окно подтверждения
2. Игрок подтверждает → `m_finished = true`, `m_nextScene = TRAVEL_CINEMA`
3. SceneManager уничтожает LocationScene
4. SceneManager создаёт TravelCinemaScene с данными маршрута
5. TravelCinemaScene инициализируется:
   - Рассчитывается расход топлива
   - Топливо списывается из PlayerState
   - Планируются события (3-4 шт)
   - Планируются диалоги (2-3 шт)
   - Планируется встреча NPC (если нужно)
6. Начинается анимация движения

**Плавность:** Fade-out → Fade-in (0.5 сек)

### TravelCinemaScene → LocationScene

**Триггер:** Прогресс достиг 100% (`m_progress >= 1.0`)

**Последовательность:**
1. TravelCinemaScene завершает все события
2. Показывается уведомление "Прибытие в [Название локации]"
3. `m_finished = true`, `m_nextScene = LOCATION`
4. SceneManager уничтожает TravelCinemaScene
5. SceneManager создаёт новый LocationScene с данными новой локации
6. Игрок оказывается в новой локации

**Плавность:** Fade-out → Fade-in (0.5 сек)

---

## 📊 Система событий EventScheduler

### Планирование событий

```cpp
class EventScheduler {
public:
    void scheduleEvents(const Route& route, float totalTime) {
        // 3-4 события на дорогу
        int numEvents = randomInt(3, 4);
        
        // 2-3 диалога
        int numDialogues = randomInt(2, 3);
        
        // 1 NPC каждые 3 дороги
        bool shouldSpawnNPC = (roadCount % 3 == 0);
        
        // Распределить события равномерно по времени
        for (int i = 0; i < numEvents; ++i) {
            float time = (totalTime / (numEvents + 1)) * (i + 1);
            m_events.push({time, pickRandomEvent()});
        }
        
        // Распределить диалоги
        for (int i = 0; i < numDialogues; ++i) {
            float time = (totalTime / (numDialogues + 1)) * (i + 1);
            // Убедиться, что не пересекается с событиями
            m_events.push({time, pickRandomDialogue()});
        }
        
        // Добавить NPC встречу
        if (shouldSpawnNPC && NPCManager::hasSpace()) {
            float time = totalTime * 0.6f; // В середине пути
            m_events.push({time, createNPCEncounter()});
        }
    }
    
private:
    std::priority_queue<ScheduledEvent> m_events;
};
```

---

## 🎨 Parallax система

### Слои параллакса

**5 слоёв с разной скоростью:**

1. **Небо** (0.1x скорость) - далёкий фон
2. **Облака** (0.3x скорость) 
3. **Горы/Деревья** (0.6x скорость)
4. **Дорога** (1.0x скорость) - базовая скорость
5. **Земля/Трава** (1.2x скорость) - передний план

```cpp
class ParallaxBackground {
public:
    void update(float deltaTime) {
        // Базовая скорость (зависит от машины)
        float baseSpeed = carSpeed * deltaTime;
        
        // Обновить каждый слой
        m_skyOffset += baseSpeed * 0.1f;
        m_cloudsOffset += baseSpeed * 0.3f;
        m_treesOffset += baseSpeed * 0.6f;
        m_roadOffset += baseSpeed * 1.0f;
        m_groundOffset += baseSpeed * 1.2f;
    }
    
    void render(sf::RenderWindow& window) {
        drawLayer(window, m_skySprite, m_skyOffset);
        drawLayer(window, m_cloudsSprite, m_cloudsOffset);
        drawLayer(window, m_treesSprite, m_treesOffset);
        drawLayer(window, m_roadSprite, m_roadOffset);
        drawLayer(window, m_groundSprite, m_groundOffset);
    }
};
```

---

## 🎯 Интеграция с другими системами

### ResourceManager

**LocationScene:**
- НЕ списывает ресурсы автоматически
- Списывает только при покупках/работе

**TravelCinemaScene:**
- Списывает топливо при инициализации
- Списывает ресурсы при событиях

### EventManager

**TravelCinemaScene использует EventManager для:**
- Получения случайных событий
- Обработки выборов игрока
- Применения последствий

### DialogueManager

**TravelCinemaScene использует DialogueManager для:**
- Показа диалогов-воспоминаний
- Показа диалогов встречи NPC

### NPCManager

**Обе сцены:**
- LocationScene: показывает UI команды
- TravelCinemaScene: обрабатывает встречу новых NPC

---

## 📦 Структуры данных

### LocationData

```cpp
struct LocationData {
    std::string id;
    std::string name;
    sf::Vector2f position;          // На карте мира
    
    std::vector<StructureType> structures;  // Доступные структуры
    
    // Связи с другими локациями
    std::vector<RouteConnection> connections;
};
```

### Route

```cpp
struct Route {
    std::string fromLocationId;
    std::string toLocationId;
    float distance;                 // км
    float travelTime;               // часы
    float fuelCost;                 // литры
    
    RoadType type;                  // highway, road, path
};
```

### GameEvent

```cpp
struct GameEvent {
    std::string id;
    EventType type;                 // EVENT, DIALOGUE, NPC_ENCOUNTER
    std::string description;
    std::vector<EventChoice> choices;
    
    // Условия
    EventCondition condition;
};

struct EventChoice {
    std::string text;
    std::vector<ResourceCost> costs;
    std::vector<Requirement> requirements;
    EventOutcome outcome;
};
```

---

## ✅ Критерии приёмки

### LocationScene готова, когда:

- [ ] Отображаются все структуры локации
- [ ] Можно взаимодействовать с каждой структурой (E key)
- [ ] Магазин: покупка/продажа работает
- [ ] Мастерская: ремонт и заправка работают
- [ ] Мотель: сон восстанавливает энергию
- [ ] Агентство: работа тратит энергию, даёт деньги
- [ ] Доска: квесты можно брать и сдавать
- [ ] Подтверждение выезда показывается корректно
- [ ] Проверки топлива работают
- [ ] Переход в TravelCinemaScene происходит плавно

### TravelCinemaScene готова, когда:

- [ ] Parallax фон движется плавно (5 слоёв)
- [ ] Прогресс-бар показывает % пути
- [ ] События появляются по расписанию (3-4 шт)
- [ ] Диалоги появляются по расписанию (2-3 шт)
- [ ] NPC встреча работает (1 раз на 3 дороги)
- [ ] Выборы в событиях применяют последствия
- [ ] Активные предметы можно использовать
- [ ] Способности NPC применяются автоматически
- [ ] Топливо списывается при старте
- [ ] Переход в LocationScene происходит после 100%

---

## 🚀 План реализации

### Этап 1: LocationScene (5-7 дней)

**День 1-2:** Базовая структура
- Создать класс LocationScene
- Реализовать рендеринг структур
- Добавить выбор структур (E key)

**День 3-4:** Структуры
- Реализовать UI магазина
- Реализовать UI мастерской
- Реализовать UI мотеля
- Реализовать UI агентства

**День 5:** Подтверждение выезда
- UI окна подтверждения
- Проверки топлива
- Расчёт расхода

**День 6-7:** Интеграция
- Связать с ResourceManager
- Связать с PlayerState
- Тестирование

### Этап 2: TravelCinemaScene (7-10 дней)

**День 1-2:** Parallax фон
- 5 слоёв с разной скоростью
- Плавное движение
- Рендеринг

**День 3-4:** EventScheduler
- Планирование событий (3-4)
- Планирование диалогов (2-3)
- Планирование NPC (1 на 3 дороги)

**День 5-6:** UI событий
- Всплывающие окна
- Обработка выборов
- Применение последствий

**День 7-8:** Интеграция
- EventManager
- DialogueManager
- NPCManager

**День 9-10:** Тестирование
- Полный цикл Location → Travel → Location
- Все события работают
- Все переходы плавные

---

## 📝 Примечания для реализации

### Важно:

1. **Две отдельные сцены** - LocationScene и TravelCinemaScene наследуют Scene
2. **Плавные переходы** - использовать fade-out/in эффекты
3. **Топливо списывается один раз** - при старте TravelCinemaScene
4. **События не блокируют** - игрок может пропустить с предметами
5. **Parallax обязателен** - 5 слоёв минимум для атмосферы

### Технические детали:

- **Разрешение:** 1366x768
- **Framerate:** 60 FPS
- **Шрифт:** Pixel-perfect monospace
- **Цвета:** Ретро-палитра (зелёный, жёлтый, красный для индикаторов)

---

**Статус:** ✅ Готово к утверждению  
**Ждёт:** Подтверждение владельца проекта  
**После утверждения:** Начать реализацию LocationScene
